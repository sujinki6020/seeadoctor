<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.co.seeadoctor.repository.mapper.ReservationMapper">
	<resultMap id="reservationMap" type="reservation">
		<result column="reserve_seq" property="reserveSeq" />
		<result column="user_seq" property="userSeq" />
		<result column="hospital_seq" property="hospitalSeq" />
		<result column="doc_code" property="docCode" />
		<result column="reserve_date" property="reserveDate" />
		<result column="reserve_time" property="reserveTime" />
		<result column="symptom" property="symptom" />
		<result column="reserve_status" property="reserveStatus" />
		<result column="review_status" property="reviewStatus" />
	</resultMap>
	<resultMap id="reservationTimeMap" type="reservationTime">
		<result column="time_seq" property="timeSeq" />
		<result column="hospital_seq" property="hospitalSeq" />
		<result column="doc_code" property="docCode" />
		<result column="date" property="date" />
		<result column="time" property="time" />
		<result column="booked_status" property="bookedStatus" />
		<result column="blocked_status" property="blockedStatus" />
	</resultMap>

	<insert id="insertReservation" parameterType="reservation">
	insert into tb_reservation (user_seq, hospital_seq, doc_code, reserve_date, reserve_time, symptom)
	values (#{userSeq}, #{hospitalSeq}, #{docCode}, #{reserveDate}, #{reserveTime}, #{symptom})
	</insert>
	
	<select id="selectTimeSeq" parameterType="reservation" resultType="int">
	select time_seq
	  from tb_reservation_time
	 where hospital_seq = #{hospitalSeq}
	   and doc_code = #{docCode}
	   and date = #{reserveDate}
	   and time = #{reserveTime}
	</select>
	
	<update id="checkedBookedStatus" parameterType="int">
	update tb_reservation_time
	   set booked_status = "t"
	 where time_seq = #{timeSeq}
	</update>
	
	<insert id="insertTimeManagement" parameterType="reservationTime">
	insert into tb_reservation_time(hospital_seq, doc_code, date, time)
	values(#{hospitalSeq}, #{docCode}, #{date}, #{time})
	</insert>
	
	<select id="selectReservationByUser" parameterType="scrollPaging" resultMap="reservationMap">
	select *
	  from tb_reservation
	 where user_seq = #{userSeq}
   	 <if test="name !=null">
	   	<choose>
		   	<when test="name eq 'reserveStatus'">
		   		and reserve_status = #{val}
		   	</when>
		   	<when test="name eq 'reserveDate'">
	   			<choose>
					<when test="val != 4">
			   			and reserve_date between date_add(now(), interval -#{val} month) and date_add(now(), interval -(#{val}-1) month)
					</when>
					<when test="val == 4">
					    and reserve_date <![CDATA[<=]]> date_add(now(), interval -4 month)
					</when>
				</choose>
		   	</when>
	   	</choose>
   	 </if>
	 order by reserve_date desc
	 limit #{start}, #{end}
	</select>

	<select id="selectReservationPop" parameterType="reservation" resultMap="reservationMap">
		select *
		  from tb_reservation
		 where hospital_seq = #{hospitalSeq}
		   and reserve_date = #{reserveDate}
		 order by cast(reserve_time as unsigned) asc
	</select>
	
	<select id="selectTimeList" parameterType="reservationTime" resultMap="reservationTimeMap">
	select *
	  from tb_reservation_time
	 where hospital_seq = #{hospitalSeq}
	   and doc_code = #{docCode}
	   and date = #{date}
	 order by time_seq asc
	</select>
	
	<update id="updateCloseTime" parameterType="hashmap">
	 update tb_reservation_time
	    set blocked_status = "t"
	 where time in 
		 <foreach collection="closeArr" item="closeTime" index="index"  open="(" close=")" separator=",">
            #{closeTime[index]}
        </foreach>
	</update>
	
		
	<select id="selectRervationByUserSeq" parameterType="int" resultMap="reservationMap">
		select *
		  from tb_reservation
		where user_seq = #{userSeq}
	</select>
	
	<update id="updateReserveStatusFinish" parameterType="int">
	update tb_reservation
	   set reserve_status = 4
	 where reserve_seq = #{reserveSeq}
	</update>
</mapper>



